<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>WordToSite | Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #FFFDF7;
            --bg-subtle: #FFF8F0;
            --surface: #FFFFFF;
            --surface-hover: #FFF5EC;
            --border: rgba(140, 120, 100, 0.18);
            --border-hover: rgba(140, 120, 100, 0.30);
            --text: #2D2926;
            --text-secondary: #4A4540;
            --text-muted: #8A8580;
            --accent: #6C5CE7;
            --accent-bright: #5A4BD1;
            --accent-dim: rgba(108,92,231,0.10);
            --green: #16A34A;
            --green-dim: rgba(22,163,74,0.12);
            --error: #DC2626;
            --shadow-sm: 0 1px 3px rgba(140,120,100,0.08), 0 1px 2px rgba(140,120,100,0.06);
            --shadow-md: 0 4px 12px rgba(140,120,100,0.08), 0 2px 4px rgba(140,120,100,0.06);
            --radius: 12px;
            --radius-sm: 8px;
            --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg); color: var(--text);
            height: 100vh; display: flex; flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* NAV */
        .nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0; z-index: 100;
        }
        .nav-inner {
            max-width: 100%; margin: 0 auto;
            padding: 0 24px; height: 56px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-brand {
            display: flex; align-items: center; gap: 10px;
            text-decoration: none; color: var(--text);
            font-weight: 700; font-size: 15px; letter-spacing: -0.3px;
        }
        .nav-logo {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #6C5CE7, #5A4BD1);
            border-radius: 7px; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 2px 12px rgba(108,92,231,0.3);
        }
        .nav-logo svg { width: 15px; height: 15px; }
        .nav-center { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
        .nav-right { display: flex; align-items: center; gap: 12px; }
        .nav-link {
            font-size: 13px; font-weight: 500;
            color: var(--text-muted); padding: 6px 12px;
            border-radius: 6px; transition: all 150ms;
            text-decoration: none;
        }
        .nav-link:hover { color: var(--text-secondary); background: var(--accent-dim); }
        .nav-link-admin {
            font-size: 13px; font-weight: 500;
            color: var(--text-muted); padding: 6px 12px;
            border-radius: 6px; transition: all 150ms;
            text-decoration: none;
            border: 1px solid var(--border);
            display: inline-flex; align-items: center; gap: 5px;
        }
        .nav-link-admin:hover { color: var(--text-secondary); border-color: var(--border-hover); background: var(--surface-hover); }
        .nav-link-admin svg { width: 14px; height: 14px; }

        /* LAYOUT */
        .editor-layout {
            flex: 1; display: flex; overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px; flex-shrink: 0;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-header h3 { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-new {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 5px 10px; font-family: inherit; font-size: 12px; font-weight: 600;
            background: var(--accent); color: #fff;
            border: none; border-radius: 6px; cursor: pointer; transition: all 150ms;
        }
        .btn-new:hover { background: var(--accent-bright); }
        .btn-new svg { width: 14px; height: 14px; }

        .session-list { flex: 1; overflow-y: auto; padding: 8px; }
        .session-item {
            display: block; width: 100%; text-align: left;
            padding: 10px 12px; margin-bottom: 2px;
            font-family: inherit; font-size: 13px; font-weight: 500;
            color: var(--text-secondary);
            background: none; border: none; border-radius: var(--radius-sm);
            cursor: pointer; transition: all 150ms;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .session-item:hover { background: var(--surface-hover); }
        .session-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
        .session-date { font-size: 11px; color: var(--text-muted); margin-top: 2px; display: block; }

        /* CHAT AREA */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            min-width: 0;
        }

        .messages {
            flex: 1; overflow-y: auto;
            padding: 24px; display: flex; flex-direction: column; gap: 16px;
        }

        .message { max-width: 720px; width: 100%; }
        .message.user { align-self: flex-end; }
        .message.assistant { align-self: flex-start; }

        .message-bubble {
            padding: 12px 16px;
            border-radius: var(--radius);
            font-size: 14px; line-height: 1.6;
            word-wrap: break-word;
        }
        .message.user .message-bubble {
            background: var(--accent); color: #fff;
            border-bottom-right-radius: 4px;
        }
        .message.assistant .message-bubble {
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .changes-badge {
            display: inline-flex; align-items: center; gap: 4px;
            margin-top: 8px; padding: 4px 10px;
            background: var(--green-dim); color: var(--green);
            font-size: 11px; font-weight: 600;
            border-radius: 100px; letter-spacing: 0.3px;
        }
        .changes-badge svg { width: 12px; height: 12px; }

        .change-detail {
            font-size: 12px; color: var(--text-muted);
            margin-top: 4px; padding-left: 4px;
        }

        .message-time {
            font-size: 11px; color: var(--text-muted);
            margin-top: 4px; padding: 0 4px;
        }

        /* TYPING INDICATOR */
        .typing-indicator {
            display: none; align-self: flex-start;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            border-bottom-left-radius: 4px;
        }
        .typing-indicator.visible { display: flex; gap: 4px; align-items: center; }
        .typing-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--text-muted);
            animation: typingBounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* INPUT */
        .chat-input-area {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }
        .chat-input-wrap {
            display: flex; flex-direction: column; gap: 12px;
            max-width: 720px; margin: 0 auto;
        }

        /* VOICE PRIMARY ZONE */
        .voice-primary-zone {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .btn-mic-primary {
            width: 64px; height: 64px; border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer; transition: all 200ms;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            box-shadow: var(--shadow-sm);
        }
        .btn-mic-primary:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: var(--shadow-md);
        }
        .btn-mic-primary:disabled {
            opacity: 0.4; cursor: not-allowed;
        }
        .btn-mic-primary:disabled:hover {
            border-color: var(--border);
            color: var(--text-muted);
            box-shadow: var(--shadow-sm);
        }
        .btn-mic-primary svg { width: 26px; height: 26px; position: relative; z-index: 1; }
        .btn-mic-primary.recording {
            background: var(--error); border-color: var(--error);
            color: #fff; box-shadow: 0 0 0 0 rgba(220,38,38,0.4);
            animation: pulse-mic 1.5s ease-in-out infinite;
        }
        .btn-mic-primary.transcribing {
            background: var(--accent); border-color: var(--accent);
            color: #fff;
        }
        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(220,38,38,0.4); }
            70% { box-shadow: 0 0 0 12px rgba(220,38,38,0); }
            100% { box-shadow: 0 0 0 0 rgba(220,38,38,0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .voice-status {
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; font-weight: 500; color: var(--text-muted);
            height: 20px;
        }
        .voice-status:empty { visibility: hidden; }
        .vc-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--error);
            animation: blink-dot 1s ease-in-out infinite;
        }
        @keyframes blink-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .vc-level-bars {
            display: flex; align-items: flex-end; gap: 2px; height: 16px;
        }
        .vc-level-bar {
            width: 3px; border-radius: 1.5px;
            background: var(--error);
            transition: height 80ms ease;
        }
        .vc-timer { font-variant-numeric: tabular-nums; }

        /* TEXT ROW (secondary) */
        .chat-text-row {
            display: flex; gap: 8px;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }
        .chat-input {
            flex: 1; padding: 12px 16px;
            font-family: inherit; font-size: 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg);
            color: var(--text);
            outline: none; resize: none;
            transition: border-color 150ms;
            min-height: 44px; max-height: 120px;
        }
        .chat-input:focus { border-color: var(--accent); }
        .chat-input::placeholder { color: var(--text-muted); }
        .btn-send {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; flex-shrink: 0;
            background: var(--accent); color: #fff;
            border: none; border-radius: var(--radius);
            cursor: pointer; transition: all 150ms;
        }
        .btn-send:hover { background: var(--accent-bright); }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-send svg { width: 18px; height: 18px; }

        /* EMPTY / LOADING */
        .loading-screen {
            flex: 1; display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 14px;
        }
        .welcome-msg {
            text-align: center; padding: 40px 24px;
            color: var(--text-muted); font-size: 14px; line-height: 1.6;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        .welcome-msg h2 { font-size: 20px; color: var(--text); margin-bottom: 4px; }
        .welcome-msg .voice-hint { color: var(--text-secondary); font-size: 15px; margin-bottom: 2px; }
        .welcome-msg .text-hint { font-size: 13px; }

        /* SITE INFO CARD */
        .site-info-card {
            width: 100%; max-width: 520px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            text-align: left;
        }
        .site-preview-wrap {
            position: relative;
            width: 100%; height: 260px;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        .site-preview-wrap iframe {
            position: absolute; top: 0; left: 0;
            width: 1280px; height: 800px;
            transform: scale(0.40625);
            transform-origin: top left;
            border: none; pointer-events: none;
        }
        .site-preview-overlay {
            position: absolute; inset: 0;
            cursor: pointer;
        }
        .site-preview-overlay:hover { background: rgba(0,0,0,0.03); }
        .site-info-body {
            padding: 14px 16px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .site-info-url {
            font-size: 13px; color: var(--text-secondary);
            display: flex; align-items: center; gap: 6px;
            word-break: break-all;
        }
        .site-info-url svg { width: 14px; height: 14px; flex-shrink: 0; color: var(--text-muted); }
        .site-info-actions {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .site-info-btn {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 7px 14px; font-family: inherit; font-size: 12px; font-weight: 600;
            border-radius: 6px; text-decoration: none;
            cursor: pointer; transition: all 150ms;
        }
        .site-info-btn svg { width: 14px; height: 14px; }
        .site-info-btn.primary {
            background: var(--accent); color: #fff; border: none;
        }
        .site-info-btn.primary:hover { background: var(--accent-bright); }
        .site-info-btn.secondary {
            background: none; color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .site-info-btn.secondary:hover { border-color: var(--border-hover); background: var(--surface-hover); }

        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .messages { padding: 16px; }
            .chat-input-area { padding: 12px 16px 16px; }
        }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-inner">
        <a class="nav-brand" href="/dashboard.html">
            <div class="nav-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            </div>
            <span>WordToSite</span>
        </a>
        <div class="nav-center" id="siteName">Loading...</div>
        <div class="nav-right">
            <a class="nav-link-admin" id="adminLink" style="display:none" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                WP Admin
            </a>
            <a class="nav-link" href="/dashboard.html">Back to Dashboard</a>
        </div>
    </div>
</nav>

<div class="editor-layout" id="editorLayout" style="display:none">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>Conversations</h3>
            <button class="btn-new" id="newSessionBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                New
            </button>
        </div>
        <div class="session-list" id="sessionList"></div>
    </aside>

    <div class="chat-area">
        <div class="messages" id="messages">
            <div class="welcome-msg" id="welcomeMsg">
                <div>
                    <h2>Chat with your site</h2>
                    <p class="voice-hint">Tap the mic and describe your changes</p>
                    <p class="text-hint">or type below</p>
                </div>
                <div class="site-info-card" id="siteInfoCard" style="display:none">
                    <div class="site-preview-wrap">
                        <iframe id="sitePreviewFrame" loading="lazy" sandbox="allow-same-origin allow-scripts" tabindex="-1"></iframe>
                        <a class="site-preview-overlay" id="sitePreviewLink" target="_blank" title="Open site in new tab"></a>
                    </div>
                    <div class="site-info-body">
                        <div class="site-info-url" id="siteInfoUrl">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                            <span id="siteUrlText"></span>
                        </div>
                        <div class="site-info-actions">
                            <a class="site-info-btn primary" id="siteVisitBtn" target="_blank">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                Visit Site
                            </a>
                            <a class="site-info-btn secondary" id="siteAdminBtn" target="_blank" style="display:none">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                WP Admin
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        <div class="chat-input-area">
            <div class="chat-input-wrap">
                <div class="voice-primary-zone">
                    <button class="btn-mic-primary" id="micBtn" title="Record voice message">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </button>
                    <div class="voice-status" id="voiceStatus"></div>
                </div>
                <div class="chat-text-row">
                    <textarea class="chat-input" id="chatInput" placeholder="or type your changes here..." rows="1"></textarea>
                    <button class="btn-send" id="sendBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading-screen" id="loadingScreen">Loading editor...</div>

<script>
const params = new URLSearchParams(window.location.search);
const siteId = params.get('site');

let currentUser = null;
let currentSite = null;
let currentSessionId = null;
let sending = false;

// Voice state
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let voiceTimer = null;
let voiceSeconds = 0;
let audioContext = null;
let analyserNode = null;
let voiceLevelRAF = null;

const $messages = document.getElementById('messages');
const $input = document.getElementById('chatInput');
const $sendBtn = document.getElementById('sendBtn');
const $typing = document.getElementById('typingIndicator');
const $sessionList = document.getElementById('sessionList');
const $welcomeMsg = document.getElementById('welcomeMsg');
const $micBtn = document.getElementById('micBtn');
const $voiceStatus = document.getElementById('voiceStatus');

// Auth guard
async function init() {
    // --- MOCK MODE (remove when real API is wired up) ---
    const isMock = !siteId;
    if (isMock) {
        currentSite = {
            site_name: 'My Awesome Site',
            wp_url: 'https://example.com',
            wp_username: 'admin',
            wp_password: 'demo',
        };
    }
    // --- END MOCK ---

    if (!isMock) {
        // Auth check
        try {
            const authRes = await fetch('/api/auth/me');
            if (!authRes.ok) throw new Error();
            const authData = await authRes.json();
            currentUser = authData.user;
        } catch {
            window.location.href = '/login.html';
            return;
        }

        // Load site
        try {
            const siteRes = await fetch(`/api/sites/${siteId}`);
            if (!siteRes.ok) throw new Error('Site not found');
            const siteData = await siteRes.json();
            currentSite = siteData.site;
        } catch {
            window.location.href = '/dashboard.html';
            return;
        }
    }

    document.getElementById('siteName').textContent = currentSite.site_name || 'Untitled Site';
    document.title = `Editor | ${currentSite.site_name || 'WordToSite'}`;

    // WP Admin link + site info card
    const wpUrl = currentSite.wp_url || currentSite.url;
    const hasCreds = currentSite.wp_username && currentSite.wp_password;

    if (hasCreds) {
        const loginUrl = `/api/wp-auto-login?url=${encodeURIComponent(currentSite.wp_url)}&u=${encodeURIComponent(currentSite.wp_username)}&p=${encodeURIComponent(currentSite.wp_password)}`;
        document.getElementById('adminLink').href = loginUrl;
        document.getElementById('adminLink').style.display = 'inline-flex';
        document.getElementById('siteAdminBtn').href = loginUrl;
        document.getElementById('siteAdminBtn').style.display = 'inline-flex';
    }

    if (wpUrl) {
        const displayUrl = wpUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
        document.getElementById('siteUrlText').textContent = displayUrl;
        document.getElementById('siteVisitBtn').href = wpUrl;
        document.getElementById('sitePreviewLink').href = wpUrl;
        document.getElementById('sitePreviewFrame').src = wpUrl;
        document.getElementById('siteInfoCard').style.display = 'block';
    }

    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('editorLayout').style.display = 'flex';

    if (!isMock) {
        await loadSessions();
        await createNewSession();
    }
}

// Sessions
async function loadSessions() {
    try {
        const res = await fetch(`/api/editor/chat/sessions?siteId=${siteId}`);
        const data = await res.json();
        renderSessionList(data.sessions || []);
    } catch {
        // Ignore
    }
}

function renderSessionList(sessions) {
    $sessionList.innerHTML = sessions.map(s => {
        const date = new Date(s.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const active = s.id === currentSessionId ? 'active' : '';
        return `<button class="session-item ${active}" data-id="${s.id}">
            ${escapeHtml(s.title)}
            <span class="session-date">${date}</span>
        </button>`;
    }).join('');

    $sessionList.querySelectorAll('.session-item').forEach(btn => {
        btn.addEventListener('click', () => switchSession(btn.dataset.id));
    });
}

async function createNewSession() {
    try {
        const res = await fetch('/api/editor/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ siteId }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || 'Failed to create session');
        currentSessionId = data.session.id;
        clearMessages();
        $welcomeMsg.style.display = '';
        await loadSessions();
    } catch (error) {
        console.error('Failed to create session:', error);
        $welcomeMsg.innerHTML = `<h2>Could not start editor</h2><p>${escapeHtml(error.message)}<br>Check the server logs for details.</p>`;
    }
}

async function switchSession(sessionId) {
    try {
        const res = await fetch(`/api/editor/chat/sessions/${sessionId}`);
        const data = await res.json();
        if (!data.session) return;

        currentSessionId = sessionId;
        clearMessages();
        $welcomeMsg.style.display = 'none';

        const visibleMessages = (data.session.messages || []).filter(m => m.role !== 'system');
        if (visibleMessages.length === 0) {
            $welcomeMsg.style.display = '';
        }

        for (const msg of visibleMessages) {
            appendMessage(msg.role, msg.content, msg.metadata);
        }
        scrollToBottom();
        await loadSessions();
    } catch (error) {
        console.error('Failed to load session:', error);
    }
}

// Messages
function clearMessages() {
    const welcome = $welcomeMsg;
    $messages.innerHTML = '';
    $messages.appendChild(welcome);
}

function appendMessage(role, content, metadata = null) {
    $welcomeMsg.style.display = 'none';

    const div = document.createElement('div');
    div.className = `message ${role}`;

    let html = `<div class="message-bubble">${role === 'assistant' ? formatMarkdown(content) : escapeHtml(content)}</div>`;

    if (metadata?.changes && metadata.changes.length > 0) {
        const successCount = metadata.changes.filter(c => c.success).length;
        html += `<div class="changes-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            ${successCount} change${successCount !== 1 ? 's' : ''} applied
        </div>`;
        for (const change of metadata.changes) {
            const label = change.type.replace(/_/g, ' ');
            const status = change.success ? 'applied' : `failed: ${change.error}`;
            html += `<div class="change-detail">${escapeHtml(label)} — ${escapeHtml(status)}</div>`;
        }
    }

    div.innerHTML = html;
    $messages.appendChild(div);
}

function scrollToBottom() {
    $messages.scrollTop = $messages.scrollHeight;
}

// Send message
async function sendMessage() {
    const text = $input.value.trim();
    if (!text || sending || !currentSessionId) return;

    sending = true;
    $sendBtn.disabled = true;
    $micBtn.disabled = true;
    $input.value = '';
    $input.style.height = 'auto';

    appendMessage('user', text);
    scrollToBottom();

    $typing.classList.add('visible');
    $messages.appendChild($typing);
    scrollToBottom();

    try {
        const res = await fetch(`/api/editor/chat/sessions/${currentSessionId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text }),
        });

        const data = await res.json();

        $typing.classList.remove('visible');

        if (data.success) {
            const metadata = data.changes?.length > 0 ? { changes: data.changes } : null;
            appendMessage('assistant', data.message, metadata);
        } else {
            appendMessage('assistant', 'Sorry, something went wrong. Please try again.');
        }
    } catch {
        $typing.classList.remove('visible');
        appendMessage('assistant', 'Failed to reach the server. Please check your connection.');
    }

    sending = false;
    $micBtn.disabled = false;
    updateSendBtn();
    scrollToBottom();
}

// Voice
function toggleVoice() {
    if (sending) return;
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.addEventListener('dataavailable', (e) => {
            if (e.data.size > 0) audioChunks.push(e.data);
        });

        mediaRecorder.addEventListener('stop', async () => {
            stream.getTracks().forEach(t => t.stop());
            stopVoiceAudioLevel();
            clearInterval(voiceTimer);

            if (audioChunks.length === 0) {
                setMicState('idle');
                return;
            }

            setMicState('transcribing');

            try {
                const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                const formData = new FormData();
                formData.append('audio', blob, 'recording.webm');

                const res = await fetch('/api/voice/transcribe', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.text && data.text.trim()) {
                    $input.value = data.text.trim();
                    sendMessage();
                }
            } catch (err) {
                console.error('Transcription failed:', err);
            }

            setMicState('idle');
        });

        mediaRecorder.start();
        isRecording = true;
        voiceSeconds = 0;
        setMicState('recording');
        startVoiceAudioLevel(stream);
        voiceTimer = setInterval(() => {
            voiceSeconds++;
            updateTimerDisplay();
        }, 1000);
    } catch (err) {
        console.error('Microphone access denied:', err);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        isRecording = false;
        mediaRecorder.stop();
    }
}

function setMicState(state) {
    $micBtn.classList.remove('recording', 'transcribing');
    isRecording = false;

    if (state === 'idle') {
        $micBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
        $voiceStatus.innerHTML = '';
    } else if (state === 'recording') {
        isRecording = true;
        $micBtn.classList.add('recording');
        $micBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
        $voiceStatus.innerHTML = '<span class="vc-dot"></span><span class="vc-level-bars" id="vcLevelBars"><span class="vc-level-bar" style="height:4px"></span><span class="vc-level-bar" style="height:4px"></span><span class="vc-level-bar" style="height:4px"></span><span class="vc-level-bar" style="height:4px"></span><span class="vc-level-bar" style="height:4px"></span></span><span class="vc-timer" id="vcTimer">0:00</span><span style="color:var(--text-muted)">tap to stop</span>';
    } else if (state === 'transcribing') {
        $micBtn.classList.add('transcribing');
        $micBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="animation:spin 1s linear infinite"><path d="M12 2a10 10 0 0 1 10 10"/></svg>';
        $voiceStatus.innerHTML = '<span style="color:var(--accent)">Transcribing...</span>';
    }
}

function startVoiceAudioLevel(stream) {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 64;
        source.connect(analyserNode);
        const dataArray = new Uint8Array(analyserNode.frequencyBinCount);

        function updateLevels() {
            analyserNode.getByteFrequencyData(dataArray);
            const bars = document.querySelectorAll('#vcLevelBars .vc-level-bar');
            if (bars.length === 0) return;
            for (let i = 0; i < bars.length; i++) {
                const val = dataArray[i * 2] || 0;
                const h = Math.max(4, (val / 255) * 16);
                bars[i].style.height = h + 'px';
            }
            voiceLevelRAF = requestAnimationFrame(updateLevels);
        }
        updateLevels();
    } catch {
        // AudioContext not supported — ignore
    }
}

function stopVoiceAudioLevel() {
    if (voiceLevelRAF) { cancelAnimationFrame(voiceLevelRAF); voiceLevelRAF = null; }
    if (audioContext) { audioContext.close().catch(() => {}); audioContext = null; }
    analyserNode = null;
}

function updateTimerDisplay() {
    const el = document.getElementById('vcTimer');
    if (el) el.textContent = formatTime(voiceSeconds);
}

function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return m + ':' + String(sec).padStart(2, '0');
}

// Input handling
$input.addEventListener('input', () => {
    $input.style.height = 'auto';
    $input.style.height = Math.min($input.scrollHeight, 120) + 'px';
    updateSendBtn();
});

$input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

$sendBtn.addEventListener('click', sendMessage);
$micBtn.addEventListener('click', toggleVoice);

document.getElementById('newSessionBtn').addEventListener('click', createNewSession);

function updateSendBtn() {
    $sendBtn.disabled = !$input.value.trim() || sending;
}

// Helpers
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatMarkdown(text) {
    if (!text) return '';
    let html = escapeHtml(text);
    // Bold
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code style="background:var(--accent-dim);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:13px;">$1</code>');
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    return html;
}

init();
</script>
</body>
</html>
